# 교착 상태(Deadlock)

![교착상태 예시](https://hoyeonkim795.github.io/assets/img/%EA%B5%90%EC%B0%A9%EC%83%81%ED%83%9C_%EA%B0%9C%EB%85%90%EA%B3%BC_%EB%B0%9C%EC%83%9D%EC%9B%90%EC%9D%B8%20(1).png)

프로세스나 스레드가 **결코 일어날 수 없는 특정 이벤트를 기다리는 상태**

- 예방 : 교착 상태 유발하는 4가지 조건 무력화 `실효성 적음`
- 회피 : 교착 상태가 발생하지 않는 수준으로 자원 할당 `실효성 적음`
- 검출 : 자원 할당 그래프를 이용
- 회복 : 교착 상태 검출후 해결 `현실적`

## 1. 교착 상태 필요 조건

**네 가지 모두 만족**해야 교착 상태에 빠질 수 있다

1. **상호 배제 조건(mutual exclusion condition)**

   - 하나의 자원은 한 번에 한 프로세스만 접근 가능하다

2. **점유와 대기 조건(hold-and-wait condition)**

   - 어떤 프로세스가 하나 이상의 자원을 점유하고 있으면서 다른 프로세스가 가지고 있는 리소스를 기다림

3. **비선점 조건(nopreemption condition)**

   - 프로세스가 작업을 마친 후 리소스를 자발적으로 반환할 때 까지 기다림(강제로 못가져옴)

4. **순환 대기 조건(circular-wait condition)**

   - 점유과 대기 관계의 프로세스들이 서로를 기다림

   

## 2. 교착 상태 예방

#### 상호배제 예방

독점적으로 사용 가능한 자원을 없앤다

#### 점유와 대기 예방

자원을 점유하고 있는 프로세스라면 다른 자원을 기다리지 못하도록 하는 방법

즉, 전부 할당하거나 아니면 아무것도 할당하지 않게 하는 방법

= 일괄 처리 방식

#### 비선점 예방

모든 자원을 뺏을 수 있도록 만드는 방법

우선순위가 낮은 프로세스는 항상 양보를 하게 된다.

#### 원형 대기 예방

프로세스를 한 줄로 길게 세운다면 그 줄의 맨 끝에서부터 문제가 해결된다

- 대신, 자원을 한 방향으로만 사용 가능하도록 설정해야 함
  - 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당
    - 그럼, 자원의 번호는 어떻게 부여할 것인가?

## 3. 교착 상태 회피

프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어주면 교착 상태가 발생하는지 파악해 그 수준 이하로 자원을 나눠주는 방법

- 교착상태 발생범위라면 대기 시키고 아니라면 할당시킴
- 자원을 많이 할당할수록 교착 상태 발생 확률이 커짐
- 할당된 자원의 수를 기준으로 안정/불안정 상태로 나뉨

### 은행원 알고리즘(Banker's Algorithm)

- **은행이 대출해주는 방식과 유사**
  - 대출금액이 대출 가능한 범위면 허용, 그렇지 않으면 거부.
- 교착 상태 회피를 구현한 방법이며, **자원의 총 수**와 **현재 할당된 자원의 수**를 기준으로 시스템을 안정/불안정 상태로 나누고 시스템이 안정 상태를 유지하도록 자원을 할당함
- 안정상태라면 자원 할당
- 불안정상태라면 다른 프로세스가 자원을 해제할 때까지 대기

#### 문제점?

- 프로세스가 자신이 사용할 모든 자원을 미리 선언해야함
- 시스템의 자원 수가 고정적이어야함
- 자원이 낭비됨

## 4. 교착 상태 검출

가장 현실적인 교착상태 해결법

OS가 프로세스의 작업을 관찰하면서 교차 상태 발생여부를 계속 주시하는 방법

1. **타임 아웃(가벼운 교착 상태 검출)**
   - 일정 시간동안 작업이 진행되지 않은 프로세스는 교착상태다!
     - 엉뚱한 프로세스가 강제 종료될 수 있다
     - 모든 시스템에 적용할 수 없다(데이터가 나뉘어진 분산 시스템의 경우)
   - Database와 OS에서 많이 선호
   - DB의 스냅숏-타임아웃-롤백, OS의 시스템 복원
2. **자원 할당 그래프 이용(무거운 교착 상태 검출)**
   - 자원이 하나일 때 사용하는 알고리즘.
   - 자원 할당 그래프 요청 간선과 할당 간선에 **예약 간선**이라는 새로운 유형의 간선을 도입
   - 교착 상태 사이클
     - ![img](https://blog.kakaocdn.net/dn/LLO72/btqENZv5gbB/sddKLOkvTXJdmwJoEDGClK/img.png)
     - 요청선 : 프로세스에서 자원으로 연결된 선
     - 할당선 : 자원에서 프로세스로 연결된 선
     - 사이클이 존재하는 지 확인
       - 자원 유형에 하나의 사례만 있으면 **교착 상태**
       - 여러 사례가 있으면 교착 상태 **가능성**
   - 사이클은 있지만 교착 상태가 아닌 경우
     - ![img](https://blog.kakaocdn.net/dn/mhf3o/btqEOQkX1ua/nJ5d1cEYEGlU8ykBDaRlq1/img.png)

## 5. 교착 상태 회복

교착 상태를 해제(해결)하는 후속 작업을 **회복**이라 부른다

1. 교착 상태를 일으킨 모든 프로세스를 동시 종료
2. 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료

  

- 우선 순위가 낮은 프로세스 먼저 종료
- 우선 순위가 같은 경우 작업 시간이 짧은 프로세스 먼저 종료
- 자원을 많이 사용하는 프로세스 먼저 종료



---

### 참고자료

- https://www.youtube.com/watch?v=FXzBRD3CPlQ
- https://velog.io/@kwt0124/03.-%EA%B5%90%EC%B0%A9-%EC%83%81%ED%83%9C-%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95

